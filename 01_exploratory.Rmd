---
title: "Carte de France des prénoms"
author: "Florian Gaudin-Delrieu"
date: "20 janvier 2017"
output: github_document
---

## Récupération des données

Les données sont en accès libre sur la plateforme [open data du gouvernement français](https://www.data.gouv.fr/fr/datasets/contours-des-departements-francais-issus-d-openstreetmap/).
Les données sont issues d'OpenStreetMap, et sont donc "© les contributeurs d'OpenStreetMap sous licence ODbL".

Les données sur les prénoms sont aussi en open source, [fournies par l'INSEE ](http://www.data.gouv.fr/fr/datasets/fichier-des-prenoms-edition-2016/).

```{r libraries, echo=TRUE}
library(sp)
library(rgdal)
library(tmap)
library(raster)
library(stringr)
library(tidyverse)
library(grid)
```
 
J'ai choisi de récupérer les données de 2014 simplifiées à 100m, qui sont moins lourdes à traiter que les données de 2017 non simplifiées.

```{r lecture données, echo=TRUE}
france <- readOGR("departements", "departements-20140306-100m", stringsAsFactors = FALSE, use_iconv = TRUE, encoding = "iso-8859-1")
france
head(france@data)
str(france@data)
```
*Note :* Pour ne plus avoir le message d'erreur `NOTE: rgdal::checkCRSArgs: no proj_defs.dat in PROJ.4 shared files`, j'ai fait comme indiqué à [cette adresse](https://gis.stackexchange.com/questions/224467/raster-error-note-rgdalcheckcrsargs-no-proj-defs-dat-in-proj-4-shared-file)'

Essayons un premier graphique à l'aide de `tmap`

```{r carteFrance}
tm_shape(france) +
  tm_borders()
```

Avec, les départements d'outre-mer (DOM) la carte est illisible. En première approche, nous allons ignorer ces DOM. Pour les exclure, nous allons utiliser le fait que les départements de France métropolitaine sont codés sur 2 chiffres alors que les DOM sont codés sur 3 chiffres.
```{r carteFranceMetro}
france <- france[str_length(france$code_insee) == 2, ]
france
tm_shape(france) + tm_borders()
```

Lisons maintenant les données des prénoms

```{r}
prenoms <- read_tsv("dpt2015.txt")
head(prenoms)
```

Les données manquantes apparaissent comme `"XXXX"` pour les années de naissance, et `"XX"` pour les départements.

```{r données manquantes}
table(prenoms$dpt == "XX") # Moins de 1% des départements sont manquants
table(prenoms$annais == "XXXX") # Il y a exactement le même nombre d'années de naissance manquantes
filter(prenoms, dpt == "XX", annais != "XXXX") # Toutes les données manquantes sont sur les mêmes lignes
```
Les données manquantes étant sur les mêmes lignes, nous allons les supprimer, puisque nous ne pouvons pas les placer par département. Nous allons renommer les variables pour des noms moins obscurs, et nous changeons le département en code_insee, pour pouvoir joindre les données avec la carte plus facilement.

```{r transformation des données}
prenoms <- prenoms %>% 
  rename(prenom = preusuel, annee = annais, code_insee = dpt) %>% 
  mutate(sexe = factor(sexe, levels = c(1, 2), labels = c("M", "F"))) %>% 
  filter(annee != "XXXX")
head(prenoms)
```

## Carte pour un prénom, toutes années confondues

Essayons de résumer les données pour un prénom (par exemple `"Florian"`), toutes années confondues
```{r calculs résumé}
florian <- prenoms %>% 
  filter(prenom == "FLORIAN") %>% 
  group_by(code_insee) %>% 
  summarise(total = sum(nombre))
```

```{r carteFlorian}
tm_shape(sp::merge(france, florian)) +
  tm_borders() +
  tm_fill(col = "total")
```

Il y a de nombreux Florian dans le Nord, intéressant ! La Corse est manquante, cela doit venir du fait que les départements sont 2A et 2B, et doivent être marqués comme 20 dans un des deux jeux de données, ce qui fait que la jointure ne marche pas.
```{r}
setdiff(unique(france$code_insee), unique(prenoms$code_insee)) # Il n'y a bien que la Corse qui pose problème
```

Changeons les départements dans prenoms pour que la jointure soit la bonne.

```{r}
prenoms_corse <- prenoms %>% 
  filter(code_insee == "20") %>% 
  mutate(code_insee = "2B", nombre = nombre / 2)


prenoms$code_insee[prenoms$code_insee == "20"] <- "2A"
prenoms$nombre[prenoms$code_insee == "2A"] <- prenoms$nombre[prenoms$code_insee == "2A"] / 2
prenoms <- prenoms %>% bind_rows(prenoms_corse) 

florian2 <- prenoms %>% 
  filter(prenom == "FLORIAN") %>% 
  group_by(code_insee) %>% 
  summarise(total = sum(nombre))

# Contrôle rapide
setdiff(florian2, florian)
```

Refaisons la carte 
```{r carteFlorianAvecCorse}
tm_shape(sp::merge(france, florian2)) +
  tm_borders() +
  tm_fill(col = "total")
```

On ne voit pas bien la région parisienne.

```{r paris}
paris <- france[france$code_insee %in% c("75", "92", "93", "94"), ]
tm_shape(sp::merge(paris, florian2))+
  tm_borders() +
  tm_fill(col = "total", breaks = seq(0, 7000, by = 1000))
```

J'ai modifié la légende manuellement pour avoir la même que sur la carte de toute la France.

## Autre approche pour les graphes

Plutôt que de supprimer les données, peut être est-il utile de "facetter" les régions que l'on ne voit pas (DOM et région parisienne) ?

```{r facets}
france2 <- readOGR("departements", "departements-20140306-100m", stringsAsFactors = FALSE, use_iconv = TRUE, encoding = "iso-8859-1")

france2$facet <- "Métropole"
france2$facet[france2$code_insee %in% c(c("75", "92", "93", "94"))] <- "Paris"
france2$facet[str_length(france2$code_insee) > 2] <- str_sub(france2$wikipedia[str_length(france2$code_insee) > 2], 4) 

tm_shape(france2) +
  tm_borders() +
  tm_facets("facet", free.coords = TRUE)
```

Ce n'est pas très satisfaisant, la métropole est beaucoup trop petite par rapport au reste. On pourrait partir sur 2 graphes : un pour la métropole et un pour les autres sous forme de facettes.

```{r deuxGraphes}
france_metro <- france2[france2$facet == "Métropole", ]
france_autre <- france2[france2$facet != "Métropole", ]

p1 <- tm_shape(france_metro) +
  tm_borders()
p2 <- tm_shape(france_autre) +
  tm_borders() +
  tm_facets("facet", free.coords = TRUE, ncol = 1)

grid.newpage()
pushViewport(viewport(layout=grid.layout(nrow = 1, ncol = 2, widths = unit(c(0.8, 0.2), "npc"))))
print(p1, vp=viewport(layout.pos.col = 1))
print(p2, vp=viewport(layout.pos.col = 2))
```

Ce n'est pas trop mal. Testons avec les prénoms

```{r facetEtPrenoms}

sort(unique(prenoms$code_insee))
```

Le problème est que les DOM ne sont pas détaillés dans le fichier prenoms : ils sont tous indiqués comme 97. On pourrait diviser en 5 le nombre donné dans le fichier, mais ça aurait bien moins de sens que pour la Corse, vu la diversité des territoires.

```{r testFlorianAvecParis}
france_autre <- france2[france2$facet == "Paris", ]

p3 <- tm_shape(sp::merge(france_metro, florian2)) +
  tm_borders() +
  tm_fill(col = "total")
p4 <- tm_shape(sp::merge(france_autre, florian2)) +
  tm_borders() +
  tm_fill(col = "total")

grid.newpage()
pushViewport(viewport(layout=grid.layout(nrow = 1, ncol = 2, widths = unit(c(0.8, 0.2), "npc"))))
print(p3, vp=viewport(layout.pos.col = 1))
print(p4, vp=viewport(layout.pos.col = 2))
```

Bon, cette approche n'est pas très concluante. Je vais plutôt faire une seule carte avec toute la France métropolitaine, sans les DOM, et sans "zoom" sur la région parisienne.

## Proportion de naissances

Le fait de dessiner le nombre de naissances donnera le plus souvent une carte des populations et ne nous renseignera pas sur la particularité d'un prénom. Donc au lieu de remplir en fonction du nombre de naissances, nous allons le faire en fonction du pourcentage de naissance de ce prénomn, dans chaque département.

```{r calculPourcentage}
naissances <- prenoms %>% 
  group_by(code_insee) %>% 
  summarise(naissances = sum(nombre))

florian3 <- inner_join(florian2, naissances) %>% 
  mutate(prop = total / naissances)

tm_shape(sp::merge(france, florian3)) +
  tm_borders(alpha = 0.5) +
  tm_fill("prop")
```

La carte est très différente de la première version ! Le Nord disparaît, et on voit une concentration dans la région Sud-Est, ainsi qu'un gros pic en Essonne et dans le Val d'Oise.

---
title: "Carte de France des prénoms"
author: "Florian Gaudin-Delrieu"
date: "20 janvier 2017"
output: github_document
---

## Récupération des données

Les données sont en accès libre sur la plateforme [open data du gouvernement français](https://www.data.gouv.fr/fr/datasets/contours-des-departements-francais-issus-d-openstreetmap/).
Les données sont issues d'OpenStreetMap, et sont donc "© les contributeurs d'OpenStreetMap sous licence ODbL".

Les données sur les prénoms sont aussi en open source, [fournies par l'INSEE ](http://www.data.gouv.fr/fr/datasets/fichier-des-prenoms-edition-2016/).

```{r libraries, echo=TRUE}
library(sp)
library(rgdal)
library(tmap)
library(raster)
library(stringr)
library(tidyverse)
```
 
J'ai choisi de récupérer les données de 2014 simplifiées à 100m, qui sont moins lourdes à traiter que les données de 2017 non simplifiées.

```{r lecture données, echo=TRUE}
france <- readOGR("departements", "departements-20140306-100m", stringsAsFactors = FALSE, use_iconv = TRUE, encoding = "iso-8859-1")
france
head(france@data)
str(france@data)
```
*Note :* Pour ne plus avoir le message d'erreur `NOTE: rgdal::checkCRSArgs: no proj_defs.dat in PROJ.4 shared files`, j'ai fait comme indiqué à [cette adresse](https://gis.stackexchange.com/questions/224467/raster-error-note-rgdalcheckcrsargs-no-proj-defs-dat-in-proj-4-shared-file)'

Essayons un premier graphique à l'aide de `tmap`

```{r carteFrance}
tm_shape(france) +
  tm_borders()
```

Avec, les départements d'outre-mer (DOM) la carte est illisible. En première approche, nous allons ignorer ces DOM. Pour les exclure, nous allons utiliser le fait que les départements de France métropolitaine sont codés sur 2 chiffres alors que les DOM sont codés sur 3 chiffres.
```{r carteFranceMetro}
france <- france[str_length(france$code_insee) == 2, ]
france
tm_shape(france) + tm_borders()
```

Lisons maintenant les données des prénoms

```{r}
prenoms <- read_tsv("dpt2015.txt")
head(prenoms)
```

Les données manquantes apparaissent comme `"XXXX"` pour les années de naissance, et `"XX"` pour les départements.

```{r données manquantes}
table(prenoms$dpt == "XX") # Moins de 1% des départements sont manquants
table(prenoms$annais == "XXXX") # Il y a exactement le même nombre d'années de naissance manquantes
filter(prenoms, dpt == "XX", annais != "XXXX") # Toutes les données manquantes sont sur les mêmes lignes
```
Les données manquantes étant sur les mêmes lignes, nous allons les supprimer, puisque nous ne pouvons pas les placer par département. Nous allons renommer les variables pour des noms moins obscurs, et nous changeons le département en code_insee, pour pouvoir joindre les données avec la carte plus facilement.

```{r transformation des données}
prenoms <- prenoms %>% 
  rename(prenom = preusuel, annee = annais, code_insee = dpt) %>% 
  mutate(sexe = factor(sexe, levels = c(1, 2), labels = c("M", "F"))) %>% 
  filter(annee != "XXXX")
head(prenoms)
```

## Carte pour un prénom, toutes années confondues

Essayons de résumer les données pour un prénom (par exemple `"Florian"`), toutes années confondues
```{r calculs résumé}
florian <- prenoms %>% 
  filter(prenom == "FLORIAN") %>% 
  group_by(code_insee) %>% 
  summarise(total = sum(nombre))
```

```{r carteFlorian}
tm_shape(sp::merge(france, florian)) +
  tm_borders() +
  tm_fill(col = "total")
```

Il y a de nombreux Florian dans le Nord, intéressant ! La Corse est manquante, cela doit venir du fait que les départements sont 2A et 2B, et doivent être marqués comme 20 dans un des deux jeux de données, ce qui fait que la jointure ne marche pas.
```{r}
setdiff(unique(france$code_insee), unique(prenoms$code_insee)) # Il n'y a bien que la Corse qui pose problème
```

Changeons les départements dans prenoms pour que la jointure soit la bonne.

```{r}
prenoms_corse <- prenoms %>% 
  filter(code_insee == "20") %>% 
  mutate(code_insee = "2B", nombre = nombre / 2)


prenoms$code_insee[prenoms$code_insee == "20"] <- "2A"
prenoms$nombre[prenoms$code_insee == "2A"] <- prenoms$nombre[prenoms$code_insee == "2A"] / 2
prenoms <- prenoms %>% bind_rows(prenoms_corse) 

florian2 <- prenoms %>% 
  filter(prenom == "FLORIAN") %>% 
  group_by(code_insee) %>% 
  summarise(total = sum(nombre))

# Contrôle rapide
setdiff(florian2, florian)
```

Refaisons la carte 
```{r carteFlorianAvecCorse}
tm_shape(sp::merge(france, florian2)) +
  tm_borders() +
  tm_fill(col = "total")
```

On ne voit pas la région parisienne